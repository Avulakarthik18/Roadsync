<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Car With Driver</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

    body{
      background:#151320;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:30px 18px;
      color:white;
    }

    .container{
      width:100%;
      max-width:900px;
      background:#1c1830;
      border:1px solid #2a2545;
      border-radius:18px;
      box-shadow:0 30px 70px rgba(0,0,0,0.6);
      padding:25px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    h2{
      font-size:22px;
      font-weight:600;
    }

    .sub{
      color:#aaa;
      font-size:13px;
      margin-top:4px;
    }

    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #3a3558;
      background:transparent;
      color:white;
      cursor:pointer;
      transition:0.2s;
      font-size:14px;
      font-weight:500;
    }

    .btn:hover{
      background:#2a2545;
    }

    fieldset{
      border:1px solid #2a2545;
      border-radius:14px;
      padding:16px;
      margin-bottom:16px;
      background:#17132a;
    }

    legend{
      padding:0 10px;
      color:#9b7cff;
      font-weight:600;
      font-size:14px;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }

    .group{
      flex:1;
      min-width:220px;
      margin-top:12px;
    }

    label{
      display:block;
      font-size:13px;
      color:#cfcfcf;
      margin-bottom:6px;
    }

    input, select, textarea{
      width:100%;
      padding:12px;
      border:none;
      border-radius:10px;
      background:#2a2545;
      color:white;
      outline:none;
      font-size:14px;
    }

    textarea{
      resize:none;
      min-height:90px;
    }

    input::placeholder, textarea::placeholder{
      color:#aaa;
    }

    .preview{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .preview img{
      width:90px;
      height:70px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid #2a2545;
    }

    .map-box{
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      background:#1c1830;
      border:1px solid #2a2545;
      font-size:13px;
      color:#cfcfcf;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .map-box span{
      color:#aaa;
    }

    .map-box button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #3a3558;
      background:transparent;
      color:white;
      cursor:pointer;
      font-weight:500;
    }

    .map-box button:hover{
      background:#2a2545;
    }

    .submit-btn{
      width:100%;
      padding:14px;
      margin-top:10px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:16px;
      background:linear-gradient(135deg,#7f5cff,#9b7cff);
      color:white;
      transition:0.2s;
    }

    .submit-btn:hover{
      transform:scale(1.02);
      opacity:0.95;
    }

    .status{
      display:none;
      margin-top:14px;
      background:#2a2545;
      border:1px solid #3a3558;
      border-radius:12px;
      padding:12px;
      color:#cfcfcf;
      font-size:14px;
      text-align:center;
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="topbar">
      <div>
        <h2>Add Car With Driver üöï</h2>
        <div class="sub">If you want to drive your car for rental customers.</div>
      </div>

      <button class="btn" onclick="window.location.href='../home/home.html'">‚Üê Back</button>
    </div>

    <form id="driverCarForm">

      <!-- ‚úÖ Driver Details -->
      <fieldset>
        <legend>Driver Details</legend>

        <div class="row">
          <div class="group">
            <label>Driver Name</label>
            <input type="text" id="driverName" placeholder="Enter driver name" required />
          </div>
          <div class="group">
            <label>Driver Age</label>
            <input type="number" id="driverAge" placeholder="Enter age" required />
          </div>
        </div>

        <div class="row">
          <div class="group">
            <label>Driver Mobile</label>
            <input type="tel" id="driverMobile" placeholder="10-digit mobile" pattern="[0-9]{10}" required />
          </div>
          <div class="group">
            <label>Driver License No.</label>
            <input type="text" id="driverLicense" placeholder="Enter license number" required />
          </div>
        </div>

      </fieldset>

      <!-- ‚úÖ Car Details -->
      <fieldset>
        <legend>Car Details</legend>

        <div class="row">
          <div class="group">
            <label>Company</label>
            <input type="text" id="company" placeholder="Eg: Hyundai, Honda" required />
          </div>

          <div class="group">
            <label>Model</label>
            <input type="text" id="model" placeholder="Eg: Verna, City" required />
          </div>
        </div>

        <div class="row">
          <div class="group">
            <label>Registration Number</label>
            <input type="text" id="regNumber" placeholder="Eg: TS09AB1234" required />
          </div>

          <div class="group">
            <label>Year</label>
            <input type="text" id="year" placeholder="Eg: 2022" />
          </div>
        </div>

        <div class="row">
          <div class="group">
            <label>Fuel</label>
            <select id="fuel">
              <option value="">Select</option>
              <option>Petrol</option>
              <option>Diesel</option>
              <option>Electric</option>
              <option>CNG</option>
            </select>
          </div>

          <div class="group">
            <label>Transmission</label>
            <select id="transmission">
              <option value="">Select</option>
              <option>Manual</option>
              <option>Automatic</option>
            </select>
          </div>

          <div class="group">
            <label>Seats</label>
            <input type="text" id="seats" placeholder="Eg: 5" />
          </div>
        </div>

        <div class="row">
          <div class="group">
            <label>KM Travelled</label>
            <input type="text" id="km" placeholder="Eg: 25000" />
          </div>

          <div class="group">
            <label>Pickup Location</label>
            <input type="text" id="location" placeholder="Eg: Hyderabad, Kukatpally" required />
          </div>
        </div>

        <div class="map-box">
          <span id="mapText">üìç Location preview will appear here</span>
          <button type="button" onclick="openMap()">View on Google Map</button>
        </div>

        <div class="row">
          <div class="group">
            <label>Price Per Month (‚Çπ)</label>
            <input type="number" id="priceMonth" placeholder="Eg: 30000" required />
          </div>

          <div class="group">
            <label>Security Deposit (‚Çπ)</label>
            <input type="number" id="deposit" placeholder="Eg: 5000" />
          </div>
        </div>

        <div class="group">
          <label>Vehicle Images (Multiple)</label>
          <input type="file" id="carImages" accept="image/*" multiple />
          <div class="preview" id="preview"></div>
        </div>

        <div class="group">
          <label>Additional Notes</label>
          <textarea id="notes" placeholder="Any car / driver info..."></textarea>
        </div>

      </fieldset>

      <button class="submit-btn" type="submit">Submit For Approval ‚úÖ</button>
      <div class="status" id="statusMsg"></div>

    </form>

  </div>

  <script>

const API_BASE = "http://127.0.0.1:3000";

// ‚úÖ Must be logged in
const user = JSON.parse(localStorage.getItem("car_rental_user"));

if(!user || !user.loggedIn){
  alert("Please login first ‚ùå");
  window.location.href = "../login.html";
}

// ‚úÖ Image preview + base64 storage
const carImages = document.getElementById("carImages");
const preview = document.getElementById("preview");

let base64Images = [];

carImages.addEventListener("change", () => {

  base64Images = [];
  preview.innerHTML = "";

  const files = Array.from(carImages.files).slice(0,2);

  files.forEach(file => {

    const reader = new FileReader();

    reader.onload = (e) => {
      base64Images.push(e.target.result);

      const img = document.createElement("img");
      img.src = e.target.result;
      preview.appendChild(img);
    };

    reader.readAsDataURL(file);
  });
});

// ‚úÖ Map preview
const locationInput = document.getElementById("location");
const mapText = document.getElementById("mapText");

locationInput.addEventListener("input", () => {

  if(locationInput.value.trim()){
    mapText.innerText = "üìç Location: " + locationInput.value.trim();
  }else{
    mapText.innerText = "üìç Location preview will appear here";
  }
});

function openMap(){

  const loc = locationInput.value.trim();

  if(!loc){
    alert("Enter location first ‚ùå");
    return;
  }

  window.open(
    `https://www.google.com/maps?q=${encodeURIComponent(loc)}`,
    "_blank"
  );
}


// ‚úÖ SUBMIT
document.getElementById("driverCarForm")
.addEventListener("submit", async (e) => {

  e.preventDefault();

  const payload = {

    owner_email: user.email,

    // ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê VERY IMPORTANT FIX
    listing_type: "With Driver",

    // DRIVER
    driver_name: document.getElementById("driverName").value.trim(),
    driver_mobile: document.getElementById("driverMobile").value.trim(),

    // CAR
    company: document.getElementById("company").value.trim(),
    model: document.getElementById("model").value.trim(),
    reg_number: document.getElementById("regNumber").value.trim(),
    year: document.getElementById("year").value.trim(),
    fuel: document.getElementById("fuel").value,
    transmission: document.getElementById("transmission").value,
    seats: document.getElementById("seats").value,
    km: document.getElementById("km").value,
    location: document.getElementById("location").value.trim(),

    price_month: Number(document.getElementById("priceMonth").value),
    deposit: Number(document.getElementById("deposit").value || 0),
    notes: document.getElementById("notes").value.trim(),

    // IMAGES
    images: base64Images
  };

  const statusMsg = document.getElementById("statusMsg");
  statusMsg.style.display = "none";

  try{

    const res = await fetch(`${API_BASE}/add-car`, {

      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)

    });

    const data = await res.json();

    statusMsg.style.display = "block";
    statusMsg.innerText = data.message;

    if(!res.ok){
      return;
    }

    alert("Car submitted for approval ‚úÖ");

    window.location.href="../home/home.html";

  }catch(err){

    console.error(err);

    alert("Cannot reach backend ‚ùå Check if Flask is running");

  }

});

</script>


</body>
</html>
