<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Car (Rental Only) - CarRentalPro</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}

    body{
      min-height:100vh;
      background:#151320;
      color:white;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:30px 18px;
    }

    .container{
      width:100%;
      max-width:1100px;
      background:#1c1830;
      border:1px solid #2a2545;
      border-radius:18px;
      box-shadow:0 30px 70px rgba(0,0,0,0.6);
      overflow:hidden;
    }

    .topbar{
      padding:22px 25px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #2a2545;
      gap:12px;
      flex-wrap:wrap;
    }

    .topbar h2{
      font-size:22px;
      font-weight:600;
      margin-bottom:4px;
    }

    .topbar p{
      font-size:13px;
      color:#aaa;
    }

    .back-btn{
      padding:10px 14px;
      background:transparent;
      border:1px solid #3a3558;
      color:white;
      border-radius:10px;
      cursor:pointer;
      transition:0.2s;
      font-size:14px;
    }

    .back-btn:hover{background:#2a2545;}

    .content{
      padding:25px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:18px;
    }

    @media(max-width:950px){
      .content{grid-template-columns:1fr;}
    }

    .card{
      background:#17132a;
      border:1px solid #2a2545;
      border-radius:16px;
      padding:18px;
    }

    .card h3{
      font-size:16px;
      font-weight:600;
      margin-bottom:14px;
      color:#9b7cff;
    }

    label{
      display:block;
      font-size:13px;
      color:#cfcfcf;
      margin-bottom:6px;
    }

    input, select, textarea{
      width:100%;
      padding:12px;
      background:#2a2545;
      border:none;
      border-radius:10px;
      color:white;
      outline:none;
      font-size:14px;
      margin-bottom:14px;
    }

    input::placeholder, textarea::placeholder{color:#aaa;}

    textarea{resize:none;min-height:85px;}

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }

    @media(max-width:650px){
      .grid{grid-template-columns:1fr;}
    }

    .btn{
      width:100%;
      padding:14px;
      background:linear-gradient(135deg,#7f5cff,#9b7cff);
      border:none;
      border-radius:12px;
      color:white;
      font-size:16px;
      cursor:pointer;
      transition:0.25s;
      font-weight:600;
      margin-top:5px;
    }

    .btn:hover{transform:scale(1.02);opacity:0.95;}

    .note{
      margin-top:12px;
      padding:12px;
      background:#2a2545;
      border:1px solid #3a3558;
      border-radius:14px;
      font-size:12px;
      color:#cfcfcf;
      line-height:1.5;
    }

    .summary-item{
      background:#2a2545;
      border:1px solid #3a3558;
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }

    .summary-item p{
      font-size:12px;
      color:#cfcfcf;
      margin-bottom:5px;
    }

    .summary-item strong{
      font-size:14px;
      color:white;
    }

    .status-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(241, 196, 15, 0.12);
      border:1px solid rgba(241, 196, 15, 0.35);
      color:#ffeaa7;
      margin-top:8px;
    }

    .upload-box{
      border:1px dashed #3a3558;
      border-radius:14px;
      padding:14px;
      background:#1c1830;
    }

    .preview{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .preview img{
      width:90px;
      height:70px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid #2a2545;
    }

    .map-box{
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid #2a2545;
    }

    iframe{
      width:100%;
      height:230px;
      border:0;
    }
  </style>
</head>

<body>

  <div class="container">

    <div class="topbar">
      <div>
        <h2>Add Car for Rental Only</h2>
        <p>Company will assign driver. Car will be listed after approval ✅</p>
      </div>
      <button class="back-btn" onclick="window.location.href='../home/home.html'">← Back</button>
    </div>

    <form id="rentalOnlyForm">
      <div class="content">

        <div class="card">
          <h3>Car Details</h3>

          <div class="grid">
            <div>
              <label>Car Company</label>
              <input type="text" id="company" placeholder="Ex: Maruti" required>
            </div>

            <div>
              <label>Car Model</label>
              <input type="text" id="model" placeholder="Ex: Swift" required>
            </div>

            <div>
              <label>Registration Number</label>
              <input type="text" id="regNumber" placeholder="Ex: AP 09 AB 1234" required>
            </div>

            <div>
              <label>Manufacture Year</label>
              <input type="number" id="year" placeholder="Ex: 2021" required min="2000" max="2030">
            </div>

            <div>
              <label>Fuel Type</label>
              <select id="fuel" required>
                <option value="">Select</option>
                <option>Petrol</option>
                <option>Diesel</option>
                <option>Electric</option>
                <option>CNG</option>
              </select>
            </div>

            <div>
              <label>Transmission</label>
              <select id="transmission" required>
                <option value="">Select</option>
                <option>Manual</option>
                <option>Automatic</option>
              </select>
            </div>

            <div>
              <label>Seating Capacity</label>
              <select id="seats" required>
                <option value="">Select</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
              </select>
            </div>

            <div>
              <label>KM Driven</label>
              <input type="number" id="km" placeholder="Ex: 45000" required min="0">
            </div>
          </div>

          <label>Pickup Location</label>
          <input type="text" id="location" placeholder="Ex: Hyderabad / Tirupati" required>

          <div class="map-box">
            <iframe id="mapFrame" src="https://www.google.com/maps?q=India&output=embed" loading="lazy"></iframe>
          </div>

          <label style="margin-top:14px;">Price Per Month (₹)</label>
          <input type="number" id="priceMonth" placeholder="Ex: 25000" required min="1000">

          <label>Security Deposit (₹)</label>
          <input type="number" id="deposit" placeholder="Ex: 5000" required min="0">

          <div class="upload-box">
            <label>Upload Vehicle Images (Max 5)</label>
            <input type="file" id="carImages" accept="image/*" multiple>
            <div class="preview" id="preview"></div>
          </div>

          <label style="margin-top:14px;">Extra Notes</label>
          <textarea id="notes" placeholder="Car condition, rules, AC, luggage, etc..."></textarea>
        </div>

        <div class="card">
          <h3>Live Summary</h3>

          <div class="summary-item">
            <p>Car</p>
            <strong id="summaryCar">-</strong>
          </div>

          <div class="summary-item">
            <p>Price / Month</p>
            <strong id="summaryPrice">₹0</strong>
          </div>

          <div class="summary-item">
            <p>Pickup Location</p>
            <strong id="summaryLocation">-</strong>
          </div>

          <div class="summary-item">
            <p>Status</p>
            <strong class="status-badge">Pending Approval</strong>
          </div>

          <button class="btn" type="submit">Submit for Approval ✅</button>

          <div class="note">
            ✅ Your car will be saved in SQLite as <b>Pending</b><br>
            ✅ Admin will approve/reject<br>
            ✅ Approved cars will appear in booking page.
          </div>
        </div>

      </div>
    </form>

  </div>

  <script>
    const API_BASE = "http://127.0.0.1:3000";

    // ✅ Must be logged in
    const user = JSON.parse(localStorage.getItem("car_rental_user"));
    if(!user || !user.loggedIn){
      alert("Please login first ❌");
      window.location.href="../login.html";
    }

    // ✅ Live Summary
    const company = document.getElementById("company");
    const model = document.getElementById("model");
    const priceMonth = document.getElementById("priceMonth");
    const locationInput = document.getElementById("location");

    function updateSummary(){
      document.getElementById("summaryCar").innerText =
        `${company.value || "-"} ${model.value || ""}`.trim();

      document.getElementById("summaryPrice").innerText =
        priceMonth.value ? `₹${priceMonth.value}` : "₹0";

      document.getElementById("summaryLocation").innerText =
        locationInput.value || "-";
    }
    [company, model, priceMonth, locationInput].forEach(el => el.addEventListener("input", updateSummary));

    // ✅ Google Map Update
    locationInput.addEventListener("input", () => {
      const loc = locationInput.value.trim();
      const mapFrame = document.getElementById("mapFrame");
      mapFrame.src = loc.length > 2
        ? `https://www.google.com/maps?q=${encodeURIComponent(loc)}&output=embed`
        : "https://www.google.com/maps?q=India&output=embed";
    });

    // ✅ Image Preview (Max 5)
    const carImages = document.getElementById("carImages");
    const preview = document.getElementById("preview");

    carImages.addEventListener("change", () => {
      preview.innerHTML = "";
      const files = Array.from(carImages.files).slice(0, 5);

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.createElement("img");
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // ✅ Submit Form to DATABASE ✅
    document.getElementById("rentalOnlyForm").addEventListener("submit", async function(e){
      e.preventDefault();

      const images = Array.from(preview.querySelectorAll("img")).map(img => img.src);

      const payload = {
        owner_email: user.email,
        listing_type: "Rental Only",

        company: company.value,
        model: model.value,
        reg_number: document.getElementById("regNumber").value,
        year: document.getElementById("year").value,
        fuel: document.getElementById("fuel").value,
        transmission: document.getElementById("transmission").value,
        seats: document.getElementById("seats").value,
        km: document.getElementById("km").value,
        location: locationInput.value,

        price_month: Number(priceMonth.value),
        deposit: Number(document.getElementById("deposit").value || 0),
        notes: document.getElementById("notes").value,

        images: images
      };

      try{
        const res = await fetch(`${API_BASE}/add-car`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        alert(data.message);

       if (!res.ok) {
    alert(data.message || "Request failed ❌");
    return;
}

alert("Car submitted for approval ✅");
window.location.href = "../home/home.html";

      }catch(err){
        alert("Backend not running ❌ Please start app.py");
      }
    });

    updateSummary();
  </script>

</body>
</html>
