<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile - CarRentalPro</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>

/* ================= GLOBAL ================= */

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Poppins',sans-serif;
}

body{
  min-height:100vh;
  background:linear-gradient(135deg,#0f0c29,#1a1440,#090616);
  color:white;
}

/* ================= HEADER ================= */

header{
  background:rgba(28,24,48,0.7);
  backdrop-filter:blur(12px);
  padding:18px 40px;
  border-bottom:1px solid #2a2545;
}

.logo{
  color:#9b7cff;
  font-size:22px;
  font-weight:600;
}

/* ================= CONTAINER ================= */

.container{
  max-width:1200px;
  margin:40px auto;
  padding:0 20px;
}

/* ================= PROFILE CARD ================= */

.profile-card{
  background:rgba(28,24,48,0.75);
  backdrop-filter:blur(16px);
  padding:26px;
  border-radius:20px;
  display:flex;
  gap:22px;
  align-items:center;
  border:1px solid #2a2545;
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
}






/* User Info */

.user-info h2{
  margin-bottom:6px;
  font-size:20px;
}

.user-info p{
  margin-top:4px;
  font-size:13px;
  color:#cfcfcf;
}

/* ================= GRID ================= */

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:22px;
  margin-top:30px;
}

/* ================= CARDS ================= */

.card{
  background:rgba(23,19,42,0.8);
  backdrop-filter:blur(12px);
  padding:22px;
  border-radius:18px;
  border:1px solid #2a2545;
  transition:.3s;
  position:relative;
  overflow:hidden;
}

.card:hover{
  transform:translateY(-6px);
  box-shadow:0 14px 30px rgba(0,0,0,0.5);
}

/* Left gradient border */

.card::before{
  content:"";
  position:absolute;
  left:0;
  top:0;
  width:4px;
  height:100%;
  background:linear-gradient(#7f5cff,#9b7cff);
}

.card h3{
  margin-bottom:12px;
  color:#9b7cff;
  font-size:15px;
}

/* Stats */

.stat{
  font-size:28px;
  font-weight:600;
  margin-top:6px;
}

.list{
  font-size:13px;
  color:#cfcfcf;
  margin-top:4px;
}

/* ================= STATUS BADGE ================= */

.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  font-size:12px;
  margin-top:6px;
  background:rgba(46, 204, 113, 0.12);
  border:1px solid rgba(46, 204, 113, 0.4);
  color:#7bed9f;
}

/* ================= BUTTON ================= */

.dashboard-btn-wrap{
  text-align:center;
  margin:50px 0;
}

.dashboard-btn{
  padding:14px 30px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#7f5cff,#9b7cff);
  color:white;
  font-size:15px;
  cursor:pointer;
  transition:.3s;
}

.dashboard-btn:hover{
  transform:scale(1.05);
}
/* Wrapper */
.profile-img-wrap{
 position:relative;
 width:90px;
 height:90px;
}

/* Profile Image */
.profile-img{
 width:100%;
 height:100%;
 border-radius:50%;
 border:3px solid #9b7cff;
 padding:4px;
 background:linear-gradient(135deg,#7f5cff,#9b7cff);
 object-fit:cover;
}


/* Edit Icon */
.edit-icon{
 position:absolute;
 bottom:0;
 right:0;
 background:#7f5cff;
 width:26px;
 height:26px;
 border-radius:50%;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:13px;
 cursor:pointer;
 border:2px solid #fff;
}

.edit-btn{
  font-size:12px;
  margin-left:10px;
  background:#7f5cff;
  padding:3px 8px;
  border-radius:8px;
  cursor:pointer;
}

.popup{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
}

.popup-box{
  background:#1a1440;
  padding:25px;
  border-radius:16px;
  width:320px;
}

.popup-box input{
  width:100%;
  padding:10px;
  margin:8px 0;
  border:none;
  border-radius:8px;
}

.popup-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.popup-actions button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#7f5cff;
  color:white;
  cursor:pointer;
}

</style>

</head>
<body>

<header>
  <div class="logo">CarRentalPro</div>
</header>

<div class="container">

<!-- PROFILE CARD -->
<div class="profile-card">

  <!-- IMAGE -->
  <div class="profile-img-wrap">

    <img id="profileImg"
         src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
         class="profile-img">

    <div class="edit-icon"
         onclick="editProfilePic()">‚úèÔ∏è</div>

    <input type="file"
           id="profileUpload"
           accept="image/*"
           hidden>

  </div>

  <!-- USER INFO -->
   <div class="user-info">

  <h2 id="userName">
  User Name
  <span class="edit-btn" onclick="openEditProfile()">
    ‚úèÔ∏è Edit
  </span>
</h2>

  <p id="userEmail">user@email.com</p>

  <p id="userPhone">üìû Phone: ‚Äî</p>
  <p id="accountId">üÜî Account ID: ‚Äî</p>
  <p id="memberSince">üìÖ Member since ‚Äî</p>

</div>

<!-- ================= EDIT POPUP ================= -->

<div id="editPopup" class="popup">

  <div class="popup-box">

    <h3>Edit Profile</h3>

    <input id="editFirstName" placeholder="First Name">
    <input id="editLastName" placeholder="Last Name">
    <input id="editPhone" placeholder="Phone Number">

    <div class="popup-actions">
      <button onclick="saveProfile()">Save</button>
      <button onclick="closeEditProfile()">Cancel</button>
    </div>

  </div>

</div>

</div>

<!-- GRID -->
  <div class="grid">

    <!-- BOOKINGS -->
    <div class="card">
      <h3>My Bookings</h3>
      <div class="stat" id="bookingCount">0</div>
      <div class="list">Active bookings</div>
    </div>

    <!-- RENTALS -->
    <div class="card">
      <h3>Rental Listings</h3>
      <div class="stat" id="rentalCount">0</div>
      <div class="list">Cars listed for rent</div>
    </div>

    <!-- SELLING -->
    <div class="card">
      <h3>Selling Listings</h3>
      <div class="stat" id="sellingCount">0</div>
      <div class="list">Cars listed for sale</div>
    </div>

    <!-- ACCOUNT -->
    <div class="card">
      <h3>Account Status</h3>
      <div class="stat">Active</div>
      <div class="badge" id="verifyBadge">Profile Verified</div>
    </div>

    <!-- DRIVER -->
    <div class="card" id="driverCard" style="display:none;">
      <h3>Driver Application</h3>
      <div class="stat" id="driverStatus">Pending</div>
      <div class="list">Verification status</div>
    </div>

    <!-- PAYMENTS -->
    <div class="card">
      <h3>Total Spending</h3>
      <div class="stat" id="totalSpent">‚Çπ0</div>
      <div class="list">Across all bookings</div>
    </div>

  </div>


  <!-- BACK BUTTON -->
  <div class="dashboard-btn-wrap">
    <button class="dashboard-btn"
      onclick="goDashboard()">
      ‚¨Ö Back to Dashboard
    </button>
  </div>

</div>


<script>

const API_BASE = "http://127.0.0.1:3000";

// USER DATA
const user =
 JSON.parse(localStorage.getItem("car_rental_user"));

if(!user){
 alert("Login required ‚ùå");
 window.location.href="../login/login.html";
}


// BASIC INFO
document.getElementById("userName").innerText =
 user.full_name || user.name || "CarRental User";

document.getElementById("userEmail").innerText =
 user.email;


// LOAD PROFILE DATA
async function loadProfile(){

 try{

  const b =
   await fetch(`${API_BASE}/my-bookings/${user.email}`)
   .then(r=>r.json());

  document.getElementById("bookingCount")
   .innerText = b.count || 0;


  const r =
   await fetch(`${API_BASE}/my-car-status/${user.email}`)
   .then(r=>r.json());

  document.getElementById("rentalCount")
   .innerText = r.cars?.length || 0;


  const s =
   await fetch(`${API_BASE}/my-selling-status/${user.email}`)
   .then(r=>r.json());

  document.getElementById("sellingCount")
   .innerText = s.cars?.length || 0;


  const d =
   await fetch(`${API_BASE}/driver-status/${user.email}`)
   .then(r=>r.json());

  if(d.applied){

    document.getElementById("driverCard")
      .style.display="block";

    document.getElementById("driverStatus")
      .innerText=d.status;

  }

 }
 catch(err){
  console.error(err);
 }

}

loadProfile();


// DASHBOARD NAV
function goDashboard(){
 window.location.href="../home/home.html";
}

// -------------------------------
// OPEN FILE PICKER
// -------------------------------
function editProfilePic(){
 document
  .getElementById("profileUpload")
  .click();
}


// -------------------------------
// UPLOAD IMAGE
// -------------------------------
document
.getElementById("profileUpload")
.addEventListener("change", async function(){

 const file = this.files[0];
 if(!file) return;

 const reader = new FileReader();

 reader.onload = async function(e){

   const base64 = e.target.result;

   // Preview instantly
   document
    .getElementById("profileImg")
    .src = base64;

   try{

     const res = await fetch(
       "http://127.0.0.1:3000/upload-profile-image",
       {
         method:"POST",
         headers:{
           "Content-Type":"application/json"
         },
         body:JSON.stringify({
           email:user.email,
           image:base64
         })
       }
     );

     const data = await res.json();

     if(data.success){
       alert("Profile image saved ‚úÖ");
     }else{
       alert("Upload failed ‚ùå");
     }

   }catch(err){
     console.error(err);
     alert("Server error ‚ùå");
   }

 };

 reader.readAsDataURL(file);

});


// -------------------------------
// LOAD SAVED IMAGE
// -------------------------------
async function loadProfileImage(){

 try{

   const res = await fetch(
     `http://127.0.0.1:3000/get-profile-image/${user.email}`
   );

   const data = await res.json();

   if(data.success && data.image){

     document
      .getElementById("profileImg")
      .src = data.image;

   }

 }catch(err){
   console.error("Image load error:", err);
 }

}
// ===============================
// LOAD ACCOUNT CREATED DATE
// ===============================
async function loadAccountDate(){

 try{

   const res = await fetch(
     `${API_BASE}/get-profile/${user.email}`
   );

   const data = await res.json();

   if(data.success){

     document.getElementById("memberSince")
       .innerText =
       "Member since " + data.created_at;

   }

 }catch(err){
   console.error("Date load error:", err);
 }

}
// ===============================
// LOAD FULL PROFILE
// ===============================
async function loadFullProfile(){

 try{

   const res = await fetch(
     `${API_BASE}/get-profile/${user.email}`
   );

   const data = await res.json();

   if(!data.success){
     console.log("Profile not found");
     return;
   }

   const p = data.profile;   // üî• IMPORTANT

   // -------------------------
   // NAME
   // -------------------------
   document.getElementById("userName").innerText =
     (p.first_name || "") + " " + (p.last_name || "");

   // -------------------------
   // EMAIL
   // -------------------------
   document.getElementById("userEmail").innerText =
     p.email || "‚Äî";

   // -------------------------
   // PHONE
   // -------------------------
   document.getElementById("userPhone").innerText =
     "Phone: " + (p.phone || "Not added");

   // -------------------------
   // ACCOUNT ID
   // -------------------------
   document.getElementById("accountId").innerText =
     "Account ID: " + (p.account_id || "‚Äî");

   // -------------------------
   // MEMBER SINCE
   // -------------------------
   document.getElementById("memberSince").innerText =
     "Member since " + (p.created_at || "‚Äî");

   // -------------------------
   // PROFILE IMAGE
   // -------------------------
   if(p.profile_img){
     document.getElementById("profileImg").src =
       p.profile_img;
   }

 }catch(err){
   console.error("Profile load error:", err);
 }

}
// open edit profile
function openEditProfile(){

 document.getElementById("editPopup").style.display="flex";

 // Prefill existing data
 document.getElementById("editFirstName").value =
   document.getElementById("userName").innerText.split(" ")[0];

 document.getElementById("editLastName").value =
   document.getElementById("userName").innerText.split(" ")[1] || "";

}

function closeEditProfile(){
 document.getElementById("editPopup").style.display="none";
}


// ===============================
// RUN ON PAGE LOAD
// ===============================
loadProfile();
loadAccountDate();
loadProfileImage();
loadFullProfile();

</script>

</body>
</html>